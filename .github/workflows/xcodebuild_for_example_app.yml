name: Xcode Build for Example App

on:
  workflow_dispatch:
  push:
    branches: [ tretnfckit-main ]
  pull_request:
    branches: [ tretnfckit-main ]

env:
  SCHEME_NAME: TRETNFCKitExample
  IOS_SIMULATOR_NAME: iPhone 15 Pro
  XCODE_SELECT_PATH: '/Applications/Xcode_15.2.app/Contents/Developer'

jobs:
  show_software_information:
    name: Show software information
    strategy:
      fail-fast: false
      matrix:
        os: [macos-13, macos-14]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
    - name: Show Xcode list
      run: ls -n /Applications | grep 'Xcode'
    - name: Show the default version of Xcode
      run: xcodebuild -version
    - name: Set Xcode version
      run: sudo xcode-select -s '${{ env.XCODE_SELECT_PATH }}'
    - name: Show lists the targets and configurations in a project, or the schemes in a workspace
      run: xcodebuild -list
      working-directory: ./Examples
    - name: Show a list of destinations
      run: xcodebuild -scheme ${{ env.SCHEME_NAME }} -showdestinations
      working-directory: ./Examples
    
  xcodebuild_for_example_app:
    name: Xcode Build for Example App
    strategy:
      fail-fast: false
      matrix:
        os: [macos-13, macos-14]
        platform: ['iOS']
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
    - name: Set Xcode version
      run: sudo xcode-select -s '${{ env.XCODE_SELECT_PATH }}'
    - name: Build the scheme
      run: |
        case ${{ matrix.platform }} in
          'iOS' ) xcodebuild -scheme ${{ env.SCHEME_NAME }} -destination 'name=${{ env.IOS_SIMULATOR_NAME }}' | tee xcodebuild-${{ matrix.platform }}.log && exit ${PIPESTATUS[0]} ;;
        esac
      working-directory: ./Examples
    - name: Upload Xcode Build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: xcodebuild log (${{ matrix.platform }})
        path: |
            Examples/xcodebuild-${{ matrix.platform }}.log
    - name: Upload Xcode DerivedData
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Xcode DerivedData (${{ matrix.platform }})
        path: |
            /Users/runner/Library/Developer/Xcode/DerivedData
